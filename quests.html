<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-P8521TN3E4"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-P8521TN3E4');
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reading Quests</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="style.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
      /* Progress strap lives in the card footer and acts like a progress bar behind the text */
      .progress-strap {
        position: relative;
        overflow: hidden;
        background: var(--bs-light);
      }
      .progress-strap .progress-fill {
        position: absolute;
        inset: 0 auto 0 0;
        width: 0%;
        background: rgba(13,110,253,0.2); /* subtle Bootstrap primary tint */
        transition: width 400ms ease;
      }
      .progress-strap small {
        position: relative; /* keep text above the fill */
        font-weight: 500;
      }

      /* Minor polish for cards */
      .quest-card .card-title {
        font-weight: 700;
      }
      .quest-card .card {
        border-radius: 0.75rem;
      }
    </style>
  </head>
  <body>
    <div id="header-placeholder"></div>

    <main class="container py-5">
      <h1 class="mb-4">My Reading Quests</h1>
      <div id="quest-grid" class="row g-4"></div>
    </main>

    <div id="footer-placeholder"></div>

    <script>
      const sheetId = "1fF7P_rtLpgdr6LadFXJ3ZhjvNVw3TCBHnHi0q4XEx9I";
      const apiKey = "AIzaSyCFcup6gSBuwCFuwNKF-gIkrK2f_6nfD0g";

      async function fetchSheetNames() {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}?fields=sheets.properties.title&key=${apiKey}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error("Failed to load sheet names");
        const json = await res.json();
        return (json.sheets || []).map(s => s.properties.title);
      }

      // Display rules:
      // - If sheet name has "(#X)", show "Base Quest #X" (strip "(#X)" from base, keep the word "Quest").
      // - Otherwise, drop the word "Quest" entirely and show just the base name.
      function formatQuestName(sheetName) {
        const numMatch = sheetName.match(/\(#\s*(\d+)\s*\)/);
        const baseNoQuest = sheetName.replace(/\s*Quest\s*$/i, "").trim();

        if (numMatch) {
          const cleanedBase = baseNoQuest.replace(/\s*\(#\s*\d+\s*\)\s*$/i, "").trim();
          return `${cleanedBase} Quest #${numMatch[1]}`;
        }
        return baseNoQuest;
      }

      async function loadQuestList() {
        const questNames = await fetchSheetNames();
        // Only sheets that end exactly with " Quest"
        const filtered = questNames.filter(name => /\sQuest\s*$/i.test(name));

        // Batch-get C1 (Published? YES/NO) and the data range B4:E
        const ranges = filtered.flatMap(name => [`${name}!C1`, `${name}!B4:E`]);
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values:batchGet?${ranges
          .map(r => "ranges=" + encodeURIComponent(r)).join("&")}&key=${apiKey}`;

        const res = await fetch(url);
        if (!res.ok) throw new Error("Failed to load quest data");
        const json = await res.json();
        const valueRanges = json.valueRanges || [];

        const questCards = [];
        for (let i = 0; i < filtered.length; i++) {
          const sheetName = filtered[i];               // keep raw sheet tab name for linking
          const displayName = formatQuestName(sheetName); // formatted title for display

          const c1Range = valueRanges[i * 2];
          const dataRange = valueRanges[i * 2 + 1];

          const published = (c1Range?.values?.[0]?.[0] || "").toLowerCase() === "yes";
          if (!published) continue;

          const rows = dataRange?.values || [];
          // rows are B:E -> [Reading Order, Title (C), Author (D), Read? (E)]
          const valid = rows.filter(row => row[1]); // only where Title exists
          const total = valid.length;
          const read = valid.filter(row => (row[3] || "").toLowerCase() === "yes").length;
          const percent = total > 0 ? Math.round((read / total) * 100) : 0;

          questCards.push({ sheetName, displayName, percent });
        }

        // Sort: most complete first; keep 100% finished quests at the end
        questCards.sort((a, b) => {
          if (a.percent === 100 && b.percent !== 100) return 1;
          if (b.percent === 100 && a.percent !== 100) return -1;
          return b.percent - a.percent;
        });

        const grid = document.getElementById("quest-grid");
        grid.innerHTML = "";

        questCards.forEach(({ sheetName, displayName, percent }) => {
          const fillColor = percent === 100 
            ? "rgba(40,167,69,0.3)"  // muted Bootstrap success green
            : "rgba(13,110,253,0.2)"; // subtle Bootstrap primary blue

          const col = document.createElement("div");
          col.className = "col-sm-6 col-md-4 col-lg-3 quest-card";
          col.innerHTML = `
            <a href="quest.html?name=${encodeURIComponent(sheetName)}" class="text-decoration-none text-dark">
              <div class="card h-100 shadow-sm">
                <div class="card-body d-flex flex-column justify-content-center text-center">
                  <h5 class="card-title mb-0">${displayName}</h5>
                </div>
                <div class="progress-strap text-center py-1 border-top">
                  <div class="progress-fill" style="width:${percent}%; background:${fillColor}"></div>
                  <small class="text-muted">${percent}% complete</small>
                </div>
              </div>
            </a>
          `;
          grid.appendChild(col);
        });
      }

      // Kickoff
      loadQuestList().catch(err => {
        console.error(err);
        const grid = document.getElementById("quest-grid");
        grid.innerHTML = `
          <div class="col-12">
            <div class="alert alert-danger">Sorry, we couldn't load your quests right now.</div>
          </div>`;
      });
    </script>

    <!-- Header / Footer includes -->
    <script>
      fetch("header.html")
        .then(r => r.text())
        .then(html => {
          document.getElementById("header-placeholder").innerHTML = html;
          if (location.hostname === "localhost" || location.hostname === "127.0.0.1") {
            document.querySelector("header")?.classList.add("dev");
          }
        });

      fetch("footer.html")
        .then(r => r.text())
        .then(html => {
          document.getElementById("footer-placeholder").innerHTML = html;
        });
    </script>
  </body>
</html>
